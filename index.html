# coding: utf-8
"""
Script para download, processamento e visualização de dados do JotForm
em mapa interativo (Folium).

Autor: Assis
Data: 2025-09-15
Descrição:
    - Faz download automático dos arquivos XLSX do JotForm
    - Processa e consolida os dados de ocorrências e área de atuação
    - Gera mapa interativo com marcadores e tabelas resumo em HTML
    - Exporta o resultado para arquivo HTML local
"""

import os
import requests
import pandas as pd
import folium
from io import BytesIO
from datetime import datetime


# ---------------------------------------------------------------------
# Configurações
# ---------------------------------------------------------------------
URL_OCORRENCIAS = "https://www.jotform.com/excel/242924996615066"
URL_AREA_ATUACAO = "https://www.jotform.com/excel/243393249284060"
OUTPUT_PATH = os.path.join(os.getcwd(), "index_Tamandatuai.html")


# ---------------------------------------------------------------------
# Funções utilitárias
# ---------------------------------------------------------------------
def baixar_excel(url: str) -> pd.DataFrame:
    """Baixa um arquivo Excel do JotForm e retorna um DataFrame Pandas."""
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        return pd.read_excel(BytesIO(response.content))
    except requests.RequestException as e:
        print(f"[ERRO] Falha ao baixar arquivo: {url}\nDetalhes: {e}")
        return pd.DataFrame()


def converter_coluna_numerica(df: pd.DataFrame, coluna: str) -> pd.Series:
    """Converte coluna de string com vírgula em número float."""
    if coluna in df.columns:
        return pd.to_numeric(
            df[coluna].astype(str).str.replace(",", ".", regex=False),
            errors="coerce"
        )
    return pd.Series(dtype="float64")


# ---------------------------------------------------------------------
# Processamento de dados
# ---------------------------------------------------------------------
print("[INFO] Baixando dados de ocorrências...")
df_ocorrencias = baixar_excel(URL_OCORRENCIAS)

print("[INFO] Baixando dados de área de atuação...")
df_area = baixar_excel(URL_AREA_ATUACAO)

if df_ocorrencias.empty or df_area.empty:
    raise SystemExit("[ERRO] Não foi possível carregar os dados necessários.")

# Filtrar ocorrências
df_ocorrencias = df_ocorrencias.dropna(subset=["NÚCLEO_DE_ATUAÇÃO"])

# Totais principais
total_ocorrencias = df_ocorrencias["OCORRÊNCIA DE CAMPO CADASTRO"].notna().sum()
soma_caixa_uma = df_ocorrencias["OCORRÊNCIA DE CAMPO CAIXA UMA"].notna().sum()
total_quantidade_instalacao = df_ocorrencias["OCORRÊNCIA DE CAMPO LIGAÇÃO"].notna().sum()

# Totais de redes
df_area["TOTAL DE REDE ESGOTO 200"] = converter_coluna_numerica(df_area, "TOTAL DE REDE ESGOTO 200")
df_area["TOTAL DE REDE 110 ÁGUA"] = converter_coluna_numerica(df_area, "TOTAL DE REDE 110 ÁGUA")

total_rede_esgoto = df_area["TOTAL DE REDE ESGOTO 200"].sum()
total_rede_agua = df_area["TOTAL DE REDE 110 ÁGUA"].sum()

print(f"[INFO] Total de Rede de Esgoto: {total_rede_esgoto}")
print(f"[INFO] Total de Rede de Água: {total_rede_agua}")

# Merge por NÚCLEO_DE_ATUAÇÃO
if "NÚCLEO_DE_ATUAÇÃO" in df_area.columns:
    df_merged = df_ocorrencias.merge(
        df_area[["NÚCLEO_DE_ATUAÇÃO", "REDE ESGOTO 200", "REDE 110 ÁGUA"]],
        on="NÚCLEO_DE_ATUAÇÃO",
        how="left"
    )
else:
    df_merged = df_ocorrencias.copy()
    print("[ALERTA] Coluna 'NÚCLEO_DE_ATUAÇÃO' não encontrada em df_area.")


# ---------------------------------------------------------------------
# Construção do Mapa
# ---------------------------------------------------------------------
m = folium.Map(location=[-23.55, -46.63], zoom_start=12)

# Título
m.get_root().html.add_child(folium.Element(
    '<h3 align="center" style="font-size:20px"><b>VU - TAMANDUATEI - ENORSIG</b></h3>'
))

# Resumo principal
tabela_resumo_html = f"""
<div style="position: fixed; top: 80px; left: 50px; width: 300px;
            background-color: white; padding: 10px; border: 2px solid grey; z-index: 9999;">
    <h4>Resumo de Ocorrências e Redes</h4>
    <table style="width: 100%; border-collapse: collapse; text-align: center;">
        <tr><th>Ocorrência</th><th>Caixa Uma</th><th>Ligações</th><th>Rede Água</th><th>Rede Esgoto</th></tr>
        <tr>
            <td>{total_ocorrencias}</td>
            <td>{soma_caixa_uma}</td>
            <td>{total_quantidade_instalacao}</td>
            <td>{total_rede_agua}</td>
            <td>{total_rede_esgoto}</td>
        </tr>
    </table>
</div>
"""
m.get_root().html.add_child(folium.Element(tabela_resumo_html))

# Resumo por tipo e última data
df_merged["DATA CADASTRO"] = pd.to_datetime(df_merged["DATA CADASTRO"], errors="coerce")
total_por_tipo = df_merged["OCORRÊNCIA DE CAMPO CADASTRO"].value_counts()
total_por_dia = df_merged.groupby(df_merged["DATA CADASTRO"].dt.date).size()
ultima_data = total_por_dia.index[-1] if not total_por_dia.empty else None
total_ultima_data = total_por_dia[ultima_data] if ultima_data else 0

tabela_tipo_html = """
<div style="position: fixed; top: 320px; left: 50px; width: 300px;
            background-color: white; padding: 10px; border: 2px solid grey; z-index: 9999;">
    <h4>Resumo por Tipo</h4>
    <table style="width: 100%; border-collapse: collapse; text-align: center;">
        <tr><th>Tipo de Ocorrência</th><th>Total</th></tr>
""" + "".join([
    f"<tr><td>{tipo}</td><td>{total}</td></tr>"
    for tipo, total in total_por_tipo.items()
]) + f"""
    </table>
    <h4>Última Data</h4>
    <table style="width: 100%; border-collapse: collapse; text-align: center;">
        <tr><th>Data</th><th>Total</th></tr>
        <tr><td>{ultima_data.strftime('%Y-%m-%d') if ultima_data else 'N/A'}</td>
            <td>{total_ultima_data}</td></tr>
    </table>
</div>
"""
m.get_root().html.add_child(folium.Element(tabela_tipo_html))

# ---------------------------------------------------------------------
# Marcadores por núcleo
# ---------------------------------------------------------------------
localizacoes_por_bairro = {}
for bairro in df_merged["NÚCLEO_DE_ATUAÇÃO"].unique():
    dados_bairro = df_merged[df_merged["NÚCLEO_DE_ATUAÇÃO"] == bairro]
    localizacoes = []
    for _, row in dados_bairro.iterrows():
        if pd.notna(row.get("Geolocation")) and "," in row["Geolocation"]:
            try:
                lat, lng = map(float, row["Geolocation"].split(","))
                foto_url = row.get("FOTO_DO_IMOVEL", "https://via.placeholder.com/150")
                localizacoes.append((
                    lat, lng, bairro,
                    row.get("FUNCIONÁRIO CADASTRO", "Não informado"),
                    row.get("OCORRÊNCIA DE CAMPO CADASTRO", "Não informada"),
                    row.get("IDENTIFICAÇÃO ÚNICA", "Não informada"),
                    foto_url
                ))
            except ValueError:
                print(f"[ERRO] Coordenadas inválidas: {row['Geolocation']}")
    localizacoes_por_bairro[bairro] = localizacoes

# Cores e ícones
cores_icones = ['red', 'blue', 'green', 'purple', 'orange', 'darkred',
                'lightred', 'beige', 'darkblue', 'darkgreen']
icons = ['info-sign', 'cloud', 'leaf', 'star', 'ok', 'bookmark',
         'cutlery', 'coffee', 'road', 'home']
cores_bairro = {
    bairro: (cores_icones[i % len(cores_icones)], icons[i % len(icons)])
    for i, bairro in enumerate(localizacoes_por_bairro)
}

# Adicionar marcadores
for bairro, localizacoes in localizacoes_por_bairro.items():
    cor, icone = cores_bairro[bairro]
    feature_group = folium.FeatureGroup(name=bairro)
    for lat, lng, bairro, funcionario, cadastro, identificacao, foto_url in localizacoes:
        popup_html = f"""
            <div>
                <h4>{bairro}</h4>
                <p><b>Funcionário:</b> {funcionario}</p>
                <p><b>Cadastro:</b> {cadastro}</p>
                <p><b>Identificação Única:</b> {identificacao}</p>
                <img src="{foto_url}" alt="Foto do Imóvel" width="100%">
            </div>
        """
        folium.Marker(
            location=[lat, lng],
            popup=folium.Popup(popup_html, max_width=300),
            icon=folium.Icon(color=cor, icon=icone)
        ).add_to(feature_group)
    feature_group.add_to(m)

folium.LayerControl().add_to(m)

# ---------------------------------------------------------------------
# Exportação
# ---------------------------------------------------------------------
m.save(OUTPUT_PATH)
print(f"[SUCESSO] Mapa salvo em: {OUTPUT_PATH}")
